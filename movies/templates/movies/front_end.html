<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>React Tutorial</title>
    <!-- Not present in the tutorial. Just for basic styling. -->
    <!--link rel="stylesheet" href="css/base.css" /-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
      </head>
      <body>
    <input type = 'hidden' id = 'csrf' value = {{csrf_token}}>
    <div id = 'content'></div>
    <style type="text/css">
        #stars{
            direction: rtl;
            unicode-bidi: bidi-override;
        }
        .last{
            color: transparent;
        }
        .starf{
          display:none
        }
        .star:hover ~ .starf {
          display:inline;
        }

        .star:hover ~ .star {
          display:none;
        }


        .container{
            width: 50%;

            margin-left: auto;
            margin-right: auto;
            
        }

        .movieContainer{
            text-align:  center;
        }
        .movieContainer img{
            margin-left: auto;
            margin-right: auto;
        }

        .emoSlider{
           margin: 10px;
        }
    </style>
    <script type="text/babel">  
        var EmotionContainer= React.createClass({
            getInitialState: function(){
                return {
                    media: 'WATCH' ,
                    movies: [],
                    presentInd:0,
                    ratings: {}}
            },
            readData: function(){

            },
            simulate: function(){
                this.sendData({simulate: 1},this.updateEmotions,this.props.eegUrl)
            },

            componentDidMount: function(){
                this.fetchMovies();
                this.detect();
            },

            detect: function(){
                if(this.props.simulate){
                    this.simulate();
                }
                else{
                    this.readData();
                }                
            },
            assignSliderValue:function(val){
                return val?this.props.high:this.props.low
            },
            fetchMovies: function(){
                $.ajax({
                  url: this.props.moviesUrl,
                  dataType: 'json',
                  cache: false,
                  context: this,
                  success: function(data){
                    this.setState(data)
                    },
                  error: function(xhr, status, err){
                    console.error(this.props.url, status, err.toString());
                  }
                });
            },
            sendData: function(toSend,callback,url){
                $.ajax({
                  url:url,
                  dataType: 'json',
                  cache: false,
                  type: 'POST',
                  beforeSend: function(xhr,settings){
                    xhr.setRequestHeader("X-CSRFToken", this.props.csrf);
                        },
                  data: {data: JSON.stringify(toSend)},
                  context: this,
                  success: function(data){
                            callback(data);
                        },
                  error: function(xhr, status, err){
                    console.error(this.props.url, status, err.toString());
                  }
                });
            },
            updateEmotions: function(data){
                    var st = {};
                    for(var dim in data){
                        st[dim] = data[dim]?this.props.high:this.props.low;
                    }
                    this.setState(st,function(){
                        this.findWords();
                    }.bind(this));
                  },
            nextMovie: function(rating){
                this.setState({
                    ratings: this.updateRatingObject(rating),
                    presentInd: this.state.presentInd+1
                },function(){
                    if(this.state.presentInd == this.state.movies.length){
                       this.sendData({'ratings':this.state.ratings},function(data){
                        console.log(data);
                       },this.props.ratingsUrl)
                    }
                }.bind(this)
                )
            },
            updateRatingObject: function(rating){
                var ratingsNew = Object.assign({},this.state.ratings);
                ratingsNew[this.state.movies[this.state.presentInd].id] = rating;
                return ratingsNew;
            },
            calculateInd: function(dim){
                return 1*(this.state[dim]>=5)
            },
            findWords: function(){
                var words = {'valence':['sad','happy'],'arousal':[['lethargic','calm'],['agitated' ,'energetic']]}
                var valInd = this.calculateInd('valence');
                var aroInd = this.calculateInd('arousal');
                var valWord = words['valence'][valInd];
                var aroWord = words['arousal'][aroInd][valInd];
                this.setState({words: [aroWord,valWord]})
            },
            render: function(){
                var dims = ['valence','arousal'];
                return(
                    <div className = 'container'>
                        {this.state.movies.length && this.state.words?
                        <div className = 'emoSliderContainer'>
                            <p>I think you are feeling <span>{this.state.words[1]}</span> and <span>{this.state.words[0]}</span> but you are
                            free to disagree by changing the slider settings</p>
                        
                            {dims.map(function(dim,i) {
                            return (
                                <EmotionSlider key = {i} 
                                    category = {dim}
                                    value = {this.state[dim]} 
                                    onChange = {function(category, value){
                                        var st = {}
                                        st[category] = value
                                        this.setState(st,function(){
                                            console.log('Value of ' + category+': '+this.state[category])
                                        }.bind(this));
                                    }.bind(this)}/>
                                 )}.bind(this))}
                        </div>
                        :<h2>Trying to read your mind...</h2>}
                        {(this.state.movies.length && this.state.presentInd<(this.state.movies.length))?
                            <MovieSlider  
                                        movie = {this.state.movies[this.state.presentInd]}
                                        nextMovie = {this.nextMovie}
                                        onRate = {this.onRate}
                                        lastMovie = {this.state.presentInd==(this.state.movies.length-1)}/>
                        : null
                        }
                </div>
                )
            }

        });



        var EmotionSlider = React.createClass({


            makeSlider: function(){
                $(function() {
                    $('#'+this.props.category).slider({
                              range: "max",
                              min: 1,
                              max: 9,
                              value: this.props.value,
                              slide: function( event, ui ) {
                                    this.props.onChange(this.props.category,
                                                        ui.value);
                              }.bind(this)                              
                            });
                      }.bind(this));
                },

            componentDidMount: function(){
               this.makeSlider();
            },

            componentDidUpdate: function(){
                this.makeSlider();
            },


            render: function(){
              return(
                <div>
                    <div id ={this.props.category} className = 'emoSlider'></div>
                </div>
                )

            }
        });

        var ResetButton = React.createClass({
            render: function(){
                return(
                    <button onClick={this.props.onClick}> Reset </button>
                )
            }
        })

        var MovieSlider = React.createClass({
            getInitialState: function(){
                return {rating: 0}
            },
            onFinish:function(){
                alert('Done!');
            },
            onRate: function(rating){
                this.setState({rating: rating||0},function(){
                    console.log(this.state.rating)
                }.bind(this));
            },
            onClickNext: function(){
            var prevRating = this.state.rating;
            this.setState({rating: 0},function(){
                    this.props.nextMovie(prevRating);
                }.bind(this));
            },
            render: function(){
                return(
                <div className = 'movieContainer'>
                        <MovieElement movie = {this.props.movie}
                                    userRating = {this.state.rating}
                                    onRate = {this.onRate}/>
                        {!this.props.lastMovie ?
                            <button onClick = {this.onClickNext}> >> </button>
                        :
                            <button onClick = {this.onClickNext}> Finish </button>
                        }
                </div>
                )
            }
        })

        //var MovieMoodPanel = React.createClass({
//
        //})

        var alertJ= function(data){
            alert(JSON.stringify(data));
        }

        var MovieElement = React.createClass({
            render: function(){
                return(
                    <div className = 'slider'>
                        <h3> {this.props.movie.title} </h3>
                        <img src = {this.props.movie.url}/>
                        <RatingStars rating = {this.props.movie.avgRating}
                                    user = {false}/>
                        <RatingStars rating = {this.props.userRating}
                                    onRatingChange= {this.props.onRate}
                                    user = {true}/>
                    </div>
                )
            }
        })

        var RatingStars = React.createClass({

            onRatingChange: function(e){
                this.props.onRatingChange(e.target.value)
            },          
            render: function(){

                return(
                        (!this.props.user)?
                        <div>{this.props.rating}</div>
                        :
                        <input type = 'text' 
                            value = {this.props.rating}
                            onChange = {this.onRatingChange}/>
                )
            }
        })

        ReactDOM.render(
          <EmotionContainer eegUrl = 'http://localhost:8000/eeg'  
                            ratingsUrl = 'http://localhost:8000/ratings' 
                            moviesUrl = 'http://localhost:8000/torate' 
                            simulate = {true} 
                            high = {7} low = {3}  
                            csrf = {document.getElementById('csrf').value}/>,
          document.getElementById('content')
        );





    </script>
    <!--                                <label> Dont predict my emotional state
                                <input type = 'checkbox' 
                                    onChange={function(e){
                                        if(e.target.checked){
                                            this.stopDetect();
                                        }
                                        else{
                                         this.startDetect();
                                        }
                                    }.bind(this)}/></label-->
      </body>
  </html>